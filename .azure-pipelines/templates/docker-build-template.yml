parameters:
  - name: CONTAINER_NAME
    type: string
  - name: DOCKERFILE_PATH
    type: string
  - name: AZURE_CONTAINER_REGISTRY
    type: string
  - name: BUILD_CONTEXT
    type: string
    default: "."
  - name: BUILD_ARGS
    type: string
    default: ""
  - name: TAG_PREFIX
    type: string
    default: ""
  - name: jobCondition
    type: string
    default: succeeded()

jobs:
  - job: BuildAndPush
    displayName: "Build and Push ${{ parameters.CONTAINER_NAME }}"
    condition: ${{ parameters.jobCondition }}
    pool:
      vmImage: "ubuntu-latest"
    steps:
      - checkout: self
        submodules: true
        persistCredentials: true

      - task: Docker@2
        displayName: "Build ${{ parameters.CONTAINER_NAME }} Image"
        inputs:
          command: "build"
          repository: "${{ parameters.CONTAINER_NAME }}"
          containerRegistry: "${{ parameters.AZURE_CONTAINER_REGISTRY }}"
          dockerfile: "${{ parameters.DOCKERFILE_PATH }}"
          buildContext: "${{ parameters.BUILD_CONTEXT }}"
          ${{ if ne(parameters.BUILD_ARGS, '') }}:
            arguments: "${{ parameters.BUILD_ARGS }}"
          tags: |
            $(Build.BuildNumber)
            latest
        condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

      - script: docker images
        displayName: "List Docker Images"

      - task: Docker@2
        displayName: "Push ${{ parameters.CONTAINER_NAME }} Image"
        inputs:
          command: "push"
          repository: "${{ parameters.CONTAINER_NAME }}"
          containerRegistry: "${{ parameters.AZURE_CONTAINER_REGISTRY }}"
          tags: |
            $(Build.BuildNumber)
            latest
        condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

      - script: |
          git tag ${{ parameters.TAG_PREFIX }}$(Build.BuildNumber)
          git push origin ${{ parameters.TAG_PREFIX }}$(Build.BuildNumber)
        displayName: "Git Tag"
        condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

      - script: |
          echo "‚úÖ ${{ parameters.CONTAINER_NAME }} image built and pushed successfully"
          echo "üê≥ Image: ${{ parameters.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ parameters.CONTAINER_NAME }}:$(Build.BuildNumber)"
        displayName: "Build Summary"
