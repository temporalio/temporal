name: Flaky Tests Report

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      output_file:
        description: 'Output file from bash script'
        required: false
        default: 'out.json'

permissions:
  contents: read
  actions: read

jobs:
  flaky-tests-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: |
          cd tools/flakes
          uv sync

      - name: Install tringa
        run: |
          uv tool install git+https://github.com/dandavison/tringa --force

      - name: Run bash script to generate output file
        id: generate-output-file
        run: |
          set -euo pipefail
          
          rm -rf out.json timeout.txt retry.txt flaky.txt
          
          tringa --json --since-days 7 repo sql \
            'select classname, name, count(*) as failure_count, max(artifact) as artifact from test where passed = false and skipped = false group by classname, name order by failure_count desc' \
            --branch main --workflow-id 80591745 https://github.com/temporalio/temporal > out.json

      - name: Run Python script to process flaky tests
        id: process-flaky-tests
        run: |
          cd tools/flakes
          uv run main.py --file ../out.json

      - name: Upload generated reports
        uses: actions/upload-artifact@v4
        if: steps.process-flaky-tests.outcome == 'success'
        with:
          name: flaky-tests-reports-${{ github.run_number }}
          path: |
            out.json
          retention-days: 30

      - name: Generate flaky tests summary
        if: steps.process-flaky-tests.outcome == 'success'
        shell: bash
        id: flaky-summary
        run: |
          # Create a summary of the flaky tests report from JSON
          if [ -f "out.json" ]; then
            # Count total failed tests
            total_failures=$(jq '. | length' out.json)
            
            # Create Slack message
            title="üìä Flaky Tests Report - Last 7 Days"
            message="*Summary:*\n"
            message+="‚Ä¢ üî¥ Total Failed Tests: ${total_failures}\n\n"
            message+="*Top Flaky Tests:*\n"
            
            # Add top 10 flaky tests to the message
            if [ "$total_failures" -gt 0 ]; then
              # Extract top 10 tests and format for Slack
              top_tests=$(jq -r '.[0:10] | .[] | "‚Ä¢ \(.name) - \(.failure_count) failures"' out.json)
              message+="${top_tests}\n"
            else
              message+="No flaky tests found in the last 7 days! üéâ\n"
            fi
            
            message+="\nüìã <https://github.com/temporalio/temporal/actions/runs/${{ github.run_id }}|View Full Report>"
          else
            title="üìä Flaky Tests Report - Last 7 Days"
            message="‚ùå Failed to generate report - no data file found"
          fi
          
          # Set environment variables for Slack
          {
            echo "SLACK_TITLE=${title}"
            echo "SLACK_MESSAGE<<EOF" >> $GITHUB_ENV
            echo "${message}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          }

      - name: Create GitHub Actions summary
        if: steps.process-flaky-tests.outcome == 'success'
        run: |
          echo "## üìä Flaky Tests Report - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "out.json" ]; then
            echo "### üî¥ Failed Tests Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test Name | Failure Count | Artifact |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|---------------|----------|" >> $GITHUB_STEP_SUMMARY
            
            # Convert JSON to markdown table
            jq -r '.[] | "| \(.name) | \(.failure_count) | \(.artifact) |"' out.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No report data available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Slack notification
        if: steps.process-flaky-tests.outcome == 'success' && steps.flaky-summary.outcome == 'success'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: "Flaky Tests Bot"
          SLACK_CHANNEL: "crew-server-testing"
          SLACK_MSG_AUTHOR: "temporal-flaky-tests"
          SLACK_FOOTER: "Generated by GitHub Actions"
          SLACK_COLOR: "warning"
          SLACK_ICON_EMOJI: ":chart_with_upwards_trend:"
        uses: rtCamp/action-slack-notify@v2
