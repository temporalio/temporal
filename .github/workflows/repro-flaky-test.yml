name: Reproduce Flaky Test

on:
  pull_request:
  push:
    branches:
      - fix-flaky-task-timeouts-test

env:
  TEMPORAL_VERSION_CHECK_DISABLED: 1

jobs:
  repro-flaky-test:
    name: Repro flaky test (run ${{ matrix.run }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        run: [1, 2, 3, 4, 5]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install stress-ng
        run: sudo apt-get update && sudo apt-get install -y stress-ng

      - run: make pre-build-functional-test-coverage

      - name: Run flaky test with CPU stress
        timeout-minutes: 40
        run: |
          # Start CPU stress in background to simulate CI load
          # This creates contention that can cause 1-second timeouts to misfire
          stress-ng --cpu 2 --timeout 600s &
          STRESS_PID=$!

          # Run the full WorkflowTestSuite which has 15 parallel tests
          make functional-test-coverage
          TEST_EXIT=$?

          # Clean up stress
          kill $STRESS_PID 2>/dev/null || true

          exit $TEST_EXIT
        env:
          PERSISTENCE_TYPE: sql
          PERSISTENCE_DRIVER: sqlite
          TEST_ARGS: "-run TestWorkflowTestSuite -count 1"
